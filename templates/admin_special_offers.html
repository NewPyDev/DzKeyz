{% extends "admin_base.html" %}

{% block page_title %}Special Offers{% endblock %}
{% block page_heading %}Special Offers Management{% endblock %}
{% block page_description %}Manage featured products and homepage banners{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-white-50">Active Offers</h6>
                            <h2 class="mb-0">{{ special_offers|length }}</h2>
                        </div>
                        <i class="bi bi-fire fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-white-50">Available Products</h6>
                            <h2 class="mb-0">{{ all_products|length }}</h2>
                        </div>
                        <i class="bi bi-box-seam fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-white-50">With Banners</h6>
                            <h2 class="mb-0">{{ special_offers|selectattr('banner_image')|list|length }}</h2>
                        </div>
                        <i class="bi bi-image fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-white-50">Homepage Slots</h6>
                            <h2 class="mb-0">5</h2>
                        </div>
                        <i class="bi bi-grid-3x3-gap fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Special Offers -->
    {% if special_offers %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-fire me-2"></i>Current Special Offers
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-4">
                {% for offer in special_offers %}
                <div class="col-lg-6 col-xl-4">
                    <div class="card border-primary">
                        <div class="position-relative">
                            {% if offer.banner_image %}
                                <img src="/static/banners/{{ offer.banner_image }}" class="card-img-top" alt="{{ offer.name }}" style="height: 200px; object-fit: cover;">
                            {% elif offer.images %}
                                {% set image_urls = offer.images|from_json %}
                                {% if image_urls %}
                                    <img src="/static/products/{{ image_urls[0] }}" class="card-img-top" alt="{{ offer.name }}" style="height: 200px; object-fit: cover;">
                                {% endif %}
                            {% else %}
                                <div class="d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
                                    <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                </div>
                            {% endif %}
                            
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-primary">Order: {{ offer.offer_order or 0 }}</span>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">{{ offer.name }}</h6>
                                <form method="POST" action="{{ url_for('toggle_special_offer', product_id=offer.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove from special offers">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </form>
                            </div>
                            
                            {% if offer.offer_label %}
                                <span class="badge bg-warning text-dark mb-2">{{ offer.offer_label }}</span>
                            {% endif %}
                            
                            <p class="card-text text-muted small">
                                {{ offer.description[:100] if offer.description else 'No description' }}
                                {% if offer.description and offer.description|length > 100 %}...{% endif %}
                            </p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold text-primary">{{ "{:,.0f}".format(offer.price_dzd) }} DZD</span>
                                {% if offer.category_name %}
                                    <span class="badge bg-secondary">{{ offer.category_name }}</span>
                                {% endif %}
                            </div>
                            
                            <button class="btn btn-outline-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#editOfferModal{{ offer.id }}">
                                <i class="bi bi-pencil me-1"></i>Edit Offer Details
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Add Products to Special Offers -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-plus-circle me-2"></i>Add Products to Special Offers
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                {% for product in all_products %}
                <div class="col-lg-4 col-md-6">
                    <div class="card {% if product.special_offer %}border-success{% else %}border-light{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">{{ product.name }}</h6>
                                <form method="POST" action="{{ url_for('toggle_special_offer', product_id=product.id) }}" class="d-inline">
                                    {% if product.special_offer %}
                                        <button type="submit" class="btn btn-sm btn-success" title="Remove from special offers">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    {% else %}
                                        <button type="submit" class="btn btn-sm btn-outline-primary" title="Add to special offers">
                                            <i class="bi bi-plus-circle"></i>
                                        </button>
                                    {% endif %}
                                </form>
                            </div>
                            
                            <p class="card-text text-muted small">
                                {{ product.description[:80] if product.description else 'No description' }}
                                {% if product.description and product.description|length > 80 %}...{% endif %}
                            </p>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">{{ "{:,.0f}".format(product.price_dzd) }} DZD</span>
                                {% if product.category_name %}
                                    <span class="badge bg-secondary">{{ product.category_name }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Offer Modals -->
{% for offer in special_offers %}
<div class="modal fade" id="editOfferModal{{ offer.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>Edit Offer: {{ offer.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_offer_details', product_id=offer.id) }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="offer_label{{ offer.id }}" class="form-label">
                                <i class="bi bi-tag me-1"></i>Offer Label
                            </label>
                            <input type="text" class="form-control" id="offer_label{{ offer.id }}" name="offer_label" 
                                   value="{{ offer.offer_label or '' }}" placeholder="e.g., Best Offer, Limited Deal">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="offer_order{{ offer.id }}" class="form-label">
                                <i class="bi bi-sort-numeric-up me-1"></i>Display Order
                            </label>
                            <input type="number" class="form-control" id="offer_order{{ offer.id }}" name="offer_order" 
                                   value="{{ offer.offer_order or 0 }}" min="0" max="100">
                        </div>
                        
                        <div class="col-12">
                            <label for="banner_image{{ offer.id }}" class="form-label">
                                <i class="bi bi-image me-1"></i>Banner Image (Optional)
                            </label>
                            <input type="file" class="form-control" id="banner_image{{ offer.id }}" name="banner_image" 
                                   accept=".jpg,.jpeg,.png,.webp">
                            <div class="form-text">
                                Upload a custom banner image for the homepage slider (recommended: 1200x400px, max 5MB)
                            </div>
                            
                            {% if offer.banner_image %}
                                <div class="mt-2">
                                    <small class="text-muted">Current banner:</small>
                                    <div class="mt-1">
                                        <img src="/static/banners/{{ offer.banner_image }}" alt="Current banner" 
                                             class="img-thumbnail" style="max-height: 100px;">
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check me-1"></i>Update Offer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh page after successful operations
document.addEventListener('DOMContentLoaded', function() {
    // Show success messages with auto-hide
    const alerts = document.querySelectorAll('.alert-success');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    });
});
</script>
{% endblock %}